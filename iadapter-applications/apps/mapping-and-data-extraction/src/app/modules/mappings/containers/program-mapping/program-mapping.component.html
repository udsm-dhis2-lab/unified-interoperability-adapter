<nz-spin [nzSpinning]="isLoading">
    <div class="inner-content">
        <button nz-button nzType="default" style="margin-bottom: 16px" (click)="goBackToProgramList()">
            Go back
        </button>

        <nz-card style="width: 100%">
            <div nz-row [nzGutter]="16">
                <!-- Left Column - Program Form Representation -->
                <div nz-col [nzSpan]="leftColumnSpan">
                    <nz-card class="card">
                        <div class="left-column">
                            <div class="program-header" *ngIf="programData">
                                <h2>{{ programData.displayName }}</h2>
                                <p class="program-description">{{ programData.description }}</p>
                                <div class="program-meta">
                                    <nz-tag [nzColor]="'blue'">{{ programData.programType }}</nz-tag>
                                    <span class="program-short-name">{{ programData.displayShortName }}</span>
                                </div>
                            </div>

                            <div class="scrollable-content">
                                <!-- Program Stage Form -->
                                <div class="program-stage" *ngIf="firstProgramStage">
                                    <div class="stage-header">
                                        <h3>{{ firstProgramStage.displayName }}</h3>
                                        <p class="stage-description">{{ firstProgramStage.description }}</p>
                                    </div>

                                    <!-- Program Stage Sections -->
                                    <div class="program-sections">
                                        <div class="section"
                                            *ngFor="let section of firstProgramStage.programStageSections; trackBy: trackBySection">
                                            <div class="section-header">
                                                <h4>{{ section.displayName }}</h4>
                                            </div>

                                            <!-- Data Elements in Section -->
                                            <div class="data-elements">
                                                <div class="data-element-field"
                                                    *ngFor="let dataElement of section.dataElements; trackBy: trackByDataElement"
                                                    [class.selected]="dataElement.selected"
                                                    [class.disabled]="selectedDataElement && selectedDataElement.id !== dataElement.id && selectedDataElement.selected"
                                                    (click)="onDataElementSelect(dataElement)">
                                                    <label class="field-label">
                                                        {{ dataElement.formName || dataElement.displayName }}
                                                    </label>
                                                    <input nz-input [placeholder]="dataElement.displayName" readonly
                                                        class="field-input"
                                                        [disabled]="selectedDataElement && selectedDataElement.id !== dataElement.id && selectedDataElement.selected" />
                                                    <div class="field-info">
                                                        <small class="field-id">ID: {{ dataElement.id }}</small>
                                                        <small class="field-name"
                                                            *ngIf="dataElement.name !== dataElement.displayName">
                                                            Name: {{ dataElement.name }}
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- No data message -->
                                <div class="no-data" *ngIf="!programData && !isLoading && !hasError">
                                    <nz-empty nzNotFoundImage="simple"
                                        nzNotFoundContent="No program data available"></nz-empty>
                                </div>

                                <!-- Error message -->
                                <div class="error-data" *ngIf="hasError && !isLoading">
                                    <nz-alert nzType="error" [nzMessage]="errorMessage" nzShowIcon
                                        [nzAction]="retryTemplate" style="margin: 16px 0;">
                                    </nz-alert>
                                    <ng-template #retryTemplate>
                                        <button nz-button nzType="primary" nzSize="small" (click)="loadProgramData()">
                                            Retry
                                        </button>
                                    </ng-template>
                                </div>
                            </div>
                        </div>
                    </nz-card>
                </div>

                <!-- Right Column - Mapping Configuration -->
                <div nz-col [nzSpan]="rightColumnSpan">
                    <div nz-row nzJustify="space-between">
                        <div nz-col nzSpan="12">
                            <!-- Collapse button -->
                            <button nz-button nzType="default" (click)="onCollapse()" class="collapse-button">
                                <span nz-icon [nzType]="leftColumnSpan === 8 ? 'right' : 'left'"
                                    nzTheme="outline"></span>
                            </button>
                        </div>
                    </div>

                    <nz-card>
                        <!-- Selected Field Info -->
                        <div class="selected-field-info" *ngIf="selectedDataElement">
                            <h4>Selected Field: {{ selectedDataElement.displayName }}</h4>
                            <div class="field-details">
                                <p><strong>Form Name:</strong> {{ selectedDataElement.formName || 'N/A' }}</p>
                                <p><strong>Internal Name:</strong> {{ selectedDataElement.name }}</p>
                                <p><strong>ID:</strong> {{ selectedDataElement.id }}</p>
                                <p *ngIf="selectedDataElement.type"><strong>Type:</strong> {{ selectedDataElement.type
                                    }}</p>
                                <div *ngIf="selectedDataElement.optionSet" class="option-set-info">
                                    <p><strong>Option Set:</strong> {{ selectedDataElement.optionSet.name }}</p>
                                    <div class="options-list">
                                        <nz-tag *ngFor="let option of selectedDataElement.optionSet.options"
                                            [nzColor]="'blue'">
                                            {{ option.name }} ({{ option.code }})
                                        </nz-tag>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mapping Configuration -->
                        <!-- Mapping Configuration -->
                        <div class="mapping-configuration"
                            *ngIf="selectedDataElement && currentMapping && rightColumnSpan === 16">
                            <nz-divider></nz-divider>
                            <h4>Mapping Configuration</h4>

                            <!-- Junction Operator (when multiple fields) -->
                            <div class="mapping-section" *ngIf="selectedDataParams.length > 1">
                                <h5>Junction Operator</h5>
                                <nz-select [(ngModel)]="junctionOperator"
                                    (ngModelChange)="updateJunctionOperator($event)" style="width: 100%">
                                    <nz-option nzValue="SPACE" nzLabel="Space"></nz-option>
                                    <nz-option nzValue="COMMA" nzLabel="Comma (,)"></nz-option>
                                    <nz-option nzValue="HYPHEN" nzLabel="Hyphen (-)"></nz-option>
                                    <nz-option nzValue="UNDERSCORE" nzLabel="Underscore (_)"></nz-option>
                                    <nz-option nzValue="PIPE" nzLabel="Pipe (|)"></nz-option>
                                </nz-select>
                            </div>

                            <!-- Custom Script Section -->
                            <div class="mapping-section">
                                <div class="section-header-with-action">
                                    <h5>Data Source Fields</h5>
                                    <button nz-button nzType="dashed" nzSize="small" (click)="addDataParam()">
                                        <span nz-icon nzType="plus"></span>
                                        Add Field
                                    </button>
                                </div>

                                <!-- Data Parameters -->
                                <div class="data-params-list">
                                    <div class="data-param-item"
                                        *ngFor="let param of selectedDataParams; let i = index">
                                        <div class="param-header">
                                            <h6>Parameter {{ i + 1 }} ($dataParams[{{ i }}])</h6>
                                            <button nz-button nzType="text" nzDanger nzSize="small"
                                                (click)="removeDataParam(i)">
                                                <span nz-icon nzType="delete"></span>
                                            </button>
                                        </div>

                                        <nz-form-item>
                                            <nz-form-label>Source Field</nz-form-label>
                                            <nz-form-control>
                                                <nz-select [ngModel]="param.value.code"
                                                    (ngModelChange)="onDataParamFieldChange(i, $event)"
                                                    nzPlaceHolder="Select source field" style="width: 100%">
                                                    <nz-option *ngFor="let field of dataTemplateFields"
                                                        [nzValue]="field.code"
                                                        [nzLabel]="field.label + ' (' + field.block + ')'">
                                                    </nz-option>
                                                </nz-select>
                                            </nz-form-control>
                                        </nz-form-item>
                                    </div>
                                </div>

                                <!-- Custom JavaScript Function Editor -->
                                <nz-form-item>
                                    <nz-form-label>Custom JavaScript Function</nz-form-label>
                                    <nz-form-control>
                                        <app-code-editor [value]="customScript"
                                            (valueChange)="updateCustomScript($event)" [height]="'200px'"
                                            [theme]="'dark'" [language]="'javascript'">
                                        </app-code-editor>
                                    </nz-form-control>
                                </nz-form-item>
                            </div>

                            <!-- Mapping Preview -->
                            <div class="mapping-section" *ngIf="currentMapping">
                                <h5>Mapping Preview</h5>
                                <div class="mapping-preview">
                                    <pre>{{ currentMapping | json }}</pre>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="mapping-actions">
                                <button nz-button nzType="primary" (click)="saveMapping()"
                                    [disabled]="!currentMapping || selectedDataParams.length === 0"
                                    style="margin-right: 8px;">
                                    <span nz-icon nzType="save"></span>
                                    Save Mapping
                                </button>
                                <button nz-button nzType="default" (click)="clearSelection()">
                                    <span nz-icon nzType="clear"></span>
                                    Clear Selection
                                </button>
                            </div>
                        </div>

                        <!-- No selection message -->
                        <div class="no-selection" *ngIf="!selectedDataElement">
                            <nz-empty nzNotFoundImage="simple"
                                nzNotFoundContent="Select a field from the form to configure mapping"></nz-empty>
                        </div>

                        <!-- Collapsed state message -->
                        <div *ngIf="rightColumnSpan !== 16 && leftColumnSpan !== 8"
                            style="margin-top: 16px; font-size: 14px; color: #888; text-align: center;">
                            Expand the right column to configure mapping.
                        </div>
                    </nz-card>
                </div>
            </div>
        </nz-card>

        <!-- Alert for user feedback -->
        <nz-alert *ngIf="false" nzType="success" nzMessage="Mapping saved successfully!" nzShowIcon nzCloseable
            style="margin-top: 16px;"></nz-alert>
    </div>
</nz-spin>